name: Kam Exec
permissions:
  contents: write
  actions: read
  id-token: write
on:
  workflow_dispatch:
    inputs:
      kam-command:
        description: Command to run
        required: false
        type: string
        default: kam version patch && kam build -r
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup kam
        uses: MemDeco-WG/setup-kam@latest
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          enable-cache: "true"
      - name: Install prerequisites (curl/jq)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq
      - name: Install cosign
        run: |
          curl -sSL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 -o /tmp/cosign
          sudo install /tmp/cosign /usr/local/bin/cosign
      - name: Fetch OIDC token for Sigstore (SIGSTORE_ID_TOKEN)
        if: ${{ env.ACTIONS_ID_TOKEN_REQUEST_URL != '' }}
        run: |
          TOKEN_JSON=$(curl -s -X POST "$ACTIONS_ID_TOKEN_REQUEST_URL" -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN")
          TOKEN_VALUE=$(echo "$TOKEN_JSON" | jq -r .value)
          echo "SIGSTORE_ID_TOKEN=$TOKEN_VALUE" >> $GITHUB_ENV
      - name: Write signing key to file (optional)
        if: ${{ secrets.KAM_SIGN_KEY != '' }}
        run: |
          mkdir -p /tmp/kam
          set -euo pipefail
          # Try to decode as base64; if that fails, treat as a raw PEM
          if echo "${{ secrets.KAM_SIGN_KEY }}" | base64 --decode >/tmp/kam/kam_key.pem 2>/dev/null; then
            echo "Decoded KAM_SIGN_KEY (base64) -> /tmp/kam/kam_key.pem"
          else
            echo "${{ secrets.KAM_SIGN_KEY }}" > /tmp/kam/kam_key.pem
          fi
          chmod 600 /tmp/kam/kam_key.pem
          echo "KAM_SIGN_KEY_PATH=/tmp/kam/kam_key.pem" >> $GITHUB_ENV

      - name: Export KAM_SIGN_PASSPHRASE (optional)
        if: ${{ secrets.KAM_SIGN_PASSPHRASE != '' }}
        run: |
          echo "KAM_SIGN_PASSPHRASE=${{ secrets.KAM_SIGN_PASSPHRASE }}" >> $GITHUB_ENV

      - name: Verify kam installation
        run: kam --version
      - name: Run kam command
        shell: bash
        run: |
          kam build --help
          chmod +x hooks/**/*
          chmod +x src/**/*
          echo "Executing: ${{ github.event.inputs.kam-command }}"
          ${{ github.event.inputs.kam-command }}
        env:
          GH_TOKEN: ${{ github.token }}
          # Allow headless/non-interactive signing using secrets/configured KAM_SIGN_KEY_PATH
          KAM_SIGN_ALLOW_NONINTERACTIVE: 1
          # Ensure hooks that rely on KAM_SIGN_ENABLED see it enabled; it's ok to override here
          KAM_SIGN_ENABLED: 1
      - name: Auto-commit changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: |
            chore: apply config - Template: ${{ github.event.inputs.template-url || 'No template' }} - Command: ${{ github.event.inputs.init-command || github.event.inputs.kam-command }}
          file_pattern: |
            **/*
            !.github/workflows/exec.yml
            !.github/workflows/init.yml
          push_options: --force-with-lease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
